<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather Map</title>

<!--  inserting jQueQue-->
    <script src="js/jquery.js"></script>

<!--  inserting Bootstrap CSS-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

<!--  inserting CSS-->
<link rel="stylesheet" href="css/weather_map.css">

<!--    insert JS key-->
    <script src="js/keys.js"></script>

    <!--    inserting Mapbox CSS-->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet'>

<!--inserting Mapbox JS-->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>

<!--    inserting mapbox-geocoder-utils-->
    <script src="js/mapbox-geocoder-utils.js"></script>

</head>

<body>
<!--bootstrap search bar for navigating to different location-->
<nav class="navbar bg-body-tertiary">
    <div class="container-fluid">
        <form class="d-flex" role="search">
            <input class="form-control me-2" id="mapSearch" type="search" placeholder="Search" aria-label="Search">
        </form>
    </div>
</nav>

<!--bootstrap nav bar with current location tacked onto the end-->
<nav class="navbar bg-body-tertiary">
    <div class="container-fluid">

        <a class="navbar-brand"><img id="navBaby" src="img/teletubby-baby.webp" alt="teletubby-baby">Sunny Side Weather Depot</a>
            <form class="d-flex">
                <text class="tracker"></text>
            </form>
    </div>
</nav>

<br>
<br>
<!--weather updates-->
<div class="row">
    <div class="col-2 border border-primary">
        <div id="currentWeather"></div>
    </div>
    <div class="col-2 border border-primary">
        <div id="dayOneWeather"></div>
    </div>
    <div class="col-2 border border-primary">
        <div id="dayTwoWeather"></div>
    </div>
    <div class="col-2 border border-primary">
        <div id="dayThreeWeather"></div>
    </div>
    <div class="col-2 border border-primary">
        <div id="dayFourWeather"></div>
    </div>
</div>

<div id="weatherBody border border-primary"></div>
<div id='map' draggable="true" style='width: auto; height: 500px;'></div>
<pre id = "coordinates" class="coordinates"></pre>


<!-- -Body-Bottom- -Body-Bottom- -Body-Bottom- -Body-Bottom- -Body-Bottom- -->
</body>


<script>
//creating map, token, marker
    myToken = "pk.eyJ1IjoidHRtZXNjYWwiLCJhIjoiY2xmOGdkMXJsMGY4cTNxbzFoYWVuN290ZyJ9.I3uIDu1U5DkPJ5Sylqbzzw";

    var token = mapboxgl.accessToken = myToken;

    mapboxgl.accessToken = token;
    let coordinates = document.getElementById('coordinates');
    var map = new mapboxgl.Map({ //<-- this creates the structure/orientation of the map
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
    });

    let marker = new mapboxgl.Marker({
        draggable: true
    })
        .setLngLat([0, 0])
        .addTo(map);

//creating function for what to do when drag stops
    function onDragEnd() {
        let lngLat = marker.getLngLat();
        $.ajax({
            url: `https://api.openweathermap.org/data/3.0/onecall?lat=${lngLat.lat}&lon=${lngLat.lng}&unit=imperial&appid=${weatherKey}`
        }).done(function (data) {
            currentWeather(data);
            dayOne(data);
            dayTwo(data);
            dayThree(data);
            dayFour(data);
        });
        console.log(lngLat);
        reverseGeocode(lngLat, token).then(function(result){
        $('.tracker').html(result);
        })
    }
    marker.on('dragend', onDragEnd);

    //creating listener w/ geo to fly to new location
    let newLocation = document.querySelector('#mapSearch');
    newLocation.addEventListener('change', function (){
        geocode(newLocation.value, token).then(function (results) {
            marker.setLngLat(results);
            map.flyTo({
                center: results,
                zoom: 9
            });

            $.ajax({
                url: `https://api.openweathermap.org/data/3.0/onecall?lat=${results[1]}&lon=${results[0]}&unit=imperial&appid=${weatherKey}`
            }).done(function (data) {
                currentWeather(data);
                dayOne(data);
                dayTwo(data);
                dayThree(data);
                dayFour(data);
            })
            $('.tracker').html(newLocation.value);
        });
    });

    function currentWeather(data){
        let currentList = "";
        let dateObj = new Date((data.current.dt) * 1000);
        let time = (dateObj.getMonth() +1) + '/' + dateObj.getDate() + '/' + dateObj.getFullYear();
        let description = data.current.weather[0].description;
        let humidity = data.current.humidity;
        let wind = data.current.wind_speed;
        let pressure = data.current.pressure;
        let temp = ((data.current.temp - 273) * (9/5) + 32).toFixed(1);

        currentList +=
            '<div>' +
            '<div>' +
            '<p>'+ 'Date: ' + time + '</p>' +
            '<p>' + 'Description: ' + description + '</p>' +
            '<p>' + 'Humidity: ' + humidity + '</p>' +
            '<p>' + 'Wind: ' + wind + '</p>' +
            '<p>' + 'Pressure: ' + pressure + '</p>' +
            '<p>' + 'Temperature: '+ temp + '</p>' +
            '</div>' + '</div>';

        $("#currentWeather").html(currentList);
    }

    function dayOne(data){
        let currentList = "";
        let dateObj =new Date((data.daily[0].dt) * 1000);
        let time = (dateObj.getMonth() +1) + '/' + dateObj.getDate() + '/' + dateObj.getFullYear();
        let description = data.daily[0].weather[0].description;
        let humidity = data.daily[0].humidity;
        let wind = data.daily[0].wind_speed;
        let pressure = data.daily[0].pressure;
        let temp = ((data.daily[0].temp.day - 273) * (9/5) + 32).toFixed(1);

        currentList +=
            '<div>' +
            '<div>' +
            '<p>'+ 'Date: ' + time + '</p>' +
            '<p>' + 'Description: ' + description + '</p>' +
            '<p>' + 'Humidity: ' + humidity + '</p>' +
            '<p>' + 'Wind: ' + wind + '</p>' +
            '<p>' + 'Pressure: ' + pressure + '</p>' +
            '<p>' + 'Temperature: '+ temp + '</p>' +
            '</div>' + '</div>';

        $("#dayOneWeather").html(currentList)
    }

    function dayTwo(data){
        let currentList = "";
        let dateObj =new Date((data.daily[1].dt) * 1000);
        let time = (dateObj.getMonth() +1) + '/' + dateObj.getDate() + '/' + dateObj.getFullYear();
        let description = data.daily[1].weather[0].description;
        let humidity = data.daily[1].humidity;
        let wind = data.daily[1].wind_speed;
        let pressure = data.daily[1].pressure;
        let temp = ((data.daily[1].temp.day - 273) * (9/5) + 32).toFixed(1);

        currentList +=
            '<div>' +
            '<div>' +
            '<p>'+ 'Date: ' + time + '</p>' +
            '<p>' + 'Description: ' + description + '</p>' +
            '<p>' + 'Humidity: ' + humidity + '</p>' +
            '<p>' + 'Wind: ' + wind + '</p>' +
            '<p>' + 'Pressure: ' + pressure + '</p>' +
            '<p>' + 'Temperature: '+ temp + '</p>' +
            '</div>' + '</div>';

        $("#dayTwoWeather").html(currentList)
    }

    function dayThree(data){
        let currentList = "";
        let dateObj =new Date((data.daily[2].dt) * 1000);
        let time = (dateObj.getMonth() +1) + '/' + dateObj.getDate() + '/' + dateObj.getFullYear();
        let description = data.daily[2].weather[0].description;
        let humidity = data.daily[2].humidity;
        let wind = data.daily[2].wind_speed;
        let pressure = data.daily[2].pressure;
        let temp = ((data.daily[2].temp.day - 273) * (9/5) + 32).toFixed(1);

        currentList +=
            '<div>' +
            '<div>' +
            '<p>'+ 'Date: ' + time + '</p>' +
            '<p>' + 'Description: ' + description + '</p>' +
            '<p>' + 'Humidity: ' + humidity + '</p>' +
            '<p>' + 'Wind: ' + wind + '</p>' +
            '<p>' + 'Pressure: ' + pressure + '</p>' +
            '<p>' + 'Temperature: '+ temp + '</p>' +
            '</div>' + '</div>';

        $("#dayThreeWeather").html(currentList)
    }

    function dayFour(data){
        let currentList = "";
        let dateObj =new Date((data.daily[3].dt) * 1000);
        let time = (dateObj.getMonth() +1) + '/' + dateObj.getDate() + '/' + dateObj.getFullYear();
        let description = data.daily[3].weather[0].description;
        let humidity = data.daily[3].humidity;
        let wind = data.daily[3].wind_speed;
        let pressure = data.daily[3].pressure;
        let temp = ((data.daily[3].temp.day - 273) * (9/5) + 32).toFixed(1);

        currentList +=
            '<div>' +
            '<div>' +
            '<p>'+ 'Date: ' + time + '</p>' +
            '<p>' + 'Description: ' + description + '</p>' +
            '<p>' + 'Humidity: ' + humidity + '</p>' +
            '<p>' + 'Wind: ' + wind + '</p>' +
            '<p>' + 'Pressure: ' + pressure + '</p>' +
            '<p>' + 'Temperature: '+ temp + '</p>' +
            '</div>' + '</div>';

        $("#dayFourWeather").html(currentList)
    }

</script>

<!--  inserting Mapbox JS-->
<script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>

<!--inserting Bootstrap JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
</html>